
#include "pwm_driver.h"
#include "stm32f10x_tim.h"
#include "FreeRTOS.h"
#include "task.h"

/*  ¹Ø±ÕJTAGµ÷ÊÔÄ£Ê½£¬ÒÔÊ¹ÓÃPA15Òı½Å */
void JTAG_Init(void)

{	
	RCC_APB2PeriphClockCmd(RCC_APB2Periph_AFIO,ENABLE);    //ÏÈ¿ªÆô¿ªÆôAFIO¸´ÓÃÊ±ÖÓ
	RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOA,ENABLE);   //Ê¹ÄÜGPIOAÍâÉèÊ±ÖÓ
	GPIO_PinRemapConfig(GPIO_Remap_SWJ_JTAGDisable,ENABLE);//¹Ø±ÕJTAG£¬±£ÁôSWD£¨Ñ¡ÔñGPIO_Remap_SWJ_Disable£¬½«Ê§È¥Á½¸öµ÷ÊÔÄ£Ê½£¬ÎğÓÃ£¡£©
}

/*  ÅäÖÃPC0¡¢PA15µÄGPIO£¬³õÊ¼»¯DRV8848Ğ¾Æ¬µÄÊ¹ÄÜÒı½Å */
void MotorEn_Init(void)
{
	RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOC,ENABLE);  	//Ê¹ÄÜC¿ÚGPIOÊ±ÖÓ
	RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOA,ENABLE);  	//Ê¹ÄÜA¿ÚGPIOÊ±ÖÓ

	GPIO_InitTypeDef GPIO_InitStruct;
	GPIO_InitStruct.GPIO_Mode=GPIO_Mode_Out_PP;     		//Ñ¡ÔñÍÆÍìÊä³ö
	GPIO_InitStruct.GPIO_Pin=GPIO_Pin_0;					//Ö¸¶¨Òı½ÅPC0,MotEn2
	GPIO_InitStruct.GPIO_Speed=GPIO_Speed_10MHz;			//ÉèÖÃÊä³öËÙÂÊ10MHz
	GPIO_Init(GPIOC,&GPIO_InitStruct);						//³õÊ¼»¯ÍâÉèGPIOC¼Ä´æÆ÷
	GPIO_ResetBits(GPIOC, GPIO_Pin_0);
	

	GPIO_InitStruct.GPIO_Mode=GPIO_Mode_Out_PP;				//Ñ¡ÔñÍÆÍìÊä³ö
	GPIO_InitStruct.GPIO_Pin=GPIO_Pin_15;					//Ö¸¶¨Òı½ÅPA15,MotEn1
	GPIO_InitStruct.GPIO_Speed=GPIO_Speed_10MHz;			//ÉèÖÃÊä³öËÙÂÊ10MHz
	GPIO_Init(GPIOA,&GPIO_InitStruct);						//³õÊ¼»¯ÍâÉèGPIOA¼Ä´æÆ÷
	GPIO_ResetBits(GPIOA, GPIO_Pin_15);	
}

/*  Ê¹ÄÜDRV8848Ğ¾Æ¬µÄnSLEEPÒı½Å */
void Motor_EN(void)
{
	GPIO_SetBits(GPIOA, GPIO_Pin_15);                     //PA15_MotorAB_EN
	GPIO_SetBits(GPIOC, GPIO_Pin_0);                      //PC0_MotorAB_EN
}

/*    ÅäÖÃTIM2¶¨Ê±Æ÷Êä³öPWM       */
void PWM_TIM2_Init(void)
{
	
	/* ¿ªÆôÊ±ÖÓ */
	RCC_APB2PeriphClockCmd(RCC_APB2Periph_AFIO,ENABLE);    //¿ªÆôAFIO¸´ÓÃÊ±ÖÓ£¬ÖØÓ³ÉäÊ¹ÓÃTIM2¶¨Ê±Æ÷
	RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOA,ENABLE);   //Ê¹ÄÜGPIOAÍâÉèÊ±ÖÓ
	RCC_APB1PeriphClockCmd(RCC_APB1Periph_TIM2,ENABLE);    //Ê¹ÄÜTIM2Ê±ÖÓ 
	
	/* GPIO³õÊ¼»¯½á¹¹Ìå */
	GPIO_InitTypeDef  GPIO_InitStructure;                 
	GPIO_InitStructure.GPIO_Pin=GPIO_Pin_0 | GPIO_Pin_1 | GPIO_Pin_2 | GPIO_Pin_3;   //TIM2 Ch1/2/3/4
	GPIO_InitStructure.GPIO_Speed=GPIO_Speed_10MHz;        //ËÙ¶È 10MHz
	GPIO_InitStructure.GPIO_Mode=GPIO_Mode_AF_PP;          //¸´ÓÃÍÆÍìÊä³ö
	GPIO_Init(GPIOA,&GPIO_InitStructure);                  //³õÊ¼»¯ GPIOA
	
    /* TIMÊ±¼ä»ùÊı³õÊ¼»¯½á¹¹Ìå */
	TIM_TimeBaseInitTypeDef  TIM_TimeBaseSrtructure;     
	TIM_TimeBaseSrtructure.TIM_Period= TIM2_Reload_Num_ARR;           //¼ÆÊıÆ÷TIMx_CNT¼ÆÊı£¬´Ó0ÀÛ¼Óµ½ARR´ÎºóÒç³ö£¬ÉèÖÃ×Ô¶¯ÖØ×°ÔØÖµ
	TIM_TimeBaseSrtructure.TIM_Prescaler=TIM2_Frequency_Divide_PSC;   //ÉèÖÃÔ¤·ÖÆµÏµÊı PSC
	TIM_TimeBaseSrtructure.TIM_ClockDivision=0;                       //1·ÖÆµ£¬ÓÃÓÚÂË²¨ĞÅºÅ¶¶¶¯
	TIM_TimeBaseSrtructure.TIM_CounterMode=TIM_CounterMode_Up;        //ÏòÉÏ¼ÆÊıÄ£Ê½Òç³ö
	TIM_TimeBaseInit(TIM2,&TIM_TimeBaseSrtructure);					  //³õÊ¼»¯TIM2µÄÊ±ÖÓ²ÎÊı
	
    /* TIMÊä³ö±È½Ï¹¦ÄÜ³õÊ¼»¯½á¹¹Ìå */
	TIM_OCInitTypeDef	TIM_OCInitStructure;             
	TIM_OCInitStructure.TIM_OCMode=TIM_OCMode_PWM1;     			  //Ñ¡Ôñ¶¨Ê±Æ÷Ä£Ê½Îª±È½ÏµÍÊä³ö¡£
	TIM_OCInitStructure.TIM_OutputState = TIM_OutputState_Enable;     //±È½ÏÊä³öÊ¹ÄÜ
	TIM_OCInitStructure.TIM_Pulse =(TIM2_Reload_Num_ARR+1)*0;         //±È½ÏÊä³öÂö³å¿í¶È£¬ÉèÖÃÕ¼¿Õ±È£¨³õÊ¼»¯ÓÃ£©,¼´CCR
	TIM_OCInitStructure.TIM_OCPolarity=TIM_OCPolarity_High;           //Êä³ö¼«ĞÔ£ºTIMÊä³ö±È½Ï¼«ĞÔ¸ß
	
	
	TIM_OC1Init(TIM2,&TIM_OCInitStructure);          				  //³õÊ¼»¯TIM2  CH1µÄÊ±ÖÓ£¬ÏÂÍ¬	
	TIM_OC2Init(TIM2,&TIM_OCInitStructure);
	TIM_OC3Init(TIM2,&TIM_OCInitStructure);
	TIM_OC4Init(TIM2,&TIM_OCInitStructure);


	
	
	/* ³õÊ¼»¯CH1/2/3/4 */
	TIM_OC1PreloadConfig(TIM2,TIM_OCPreload_Enable);                  //CH1 Ô¤×°ÔØÊ¹ÄÜ£¬¹¦ÄÜÔÚARRºÍCCR1¸Ä±äÊ±£¬µÈËûÃÇ¼ÆÊıÍêÒ»¸öÖÜÆÚÔÙĞŞ¸Ä
	TIM_OC2PreloadConfig(TIM2,TIM_OCPreload_Enable);                  //CH2 Ô¤×°ÔØÊ¹ÄÜ
	TIM_OC3PreloadConfig(TIM2,TIM_OCPreload_Enable);                  //CH3 Ô¤×°ÔØÊ¹ÄÜ
	TIM_OC4PreloadConfig(TIM2,TIM_OCPreload_Enable);                  //CH4 Ô¤×°ÔØÊ¹ÄÜ
	TIM_ARRPreloadConfig(TIM2,ENABLE);                                //Ê¹ÄÜ TIMxÔÚARRÉÏµÄÔ¤×°ÔØ¼Ä´æÆ÷
	
	TIM_Cmd(TIM2, ENABLE);                                            //Ê¹ÄÜ TIM2

	
}

#if 0
void pwm_init()
{
	JTAG_Init();	
	MotorEn_Init(); 
	Motor_EN();

	os_delay(100);

	PWM_TIM2_Init();                //TIM2_PWM
    PWM_TIM4_Init();                //TIM4_PWM
}

#endif

void PWM_TIM4_Init(void)
{
	/* ¿ªÆôÊ±ÖÓ */
	RCC_APB2PeriphClockCmd(RCC_APB2Periph_AFIO,ENABLE);    //¿ªÆôAFIO¸´ÓÃÊ±ÖÓ£¬ÖØÓ³ÉäÊ¹ÓÃTIM4¶¨Ê±Æ÷
	RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOB,ENABLE);   //Ê¹ÄÜGPIOBÍâÉèÊ±ÖÓ
	RCC_APB1PeriphClockCmd(RCC_APB1Periph_TIM4,ENABLE);    //Ê¹ÄÜTIM4Ê±ÖÓ 
	
	/* GPIO³õÊ¼»¯½á¹¹Ìå */
	GPIO_InitTypeDef  GPIO_InitStructure;                 
	GPIO_InitStructure.GPIO_Pin=GPIO_Pin_6 | GPIO_Pin_7 | GPIO_Pin_8 | GPIO_Pin_9;   //TIM4 Ch1/2/3/4
	GPIO_InitStructure.GPIO_Speed=GPIO_Speed_10MHz;        //ËÙ¶È 10MHz
	GPIO_InitStructure.GPIO_Mode=GPIO_Mode_AF_PP;          //¸´ÓÃÍÆÍìÊä³ö
	GPIO_Init(GPIOB,&GPIO_InitStructure);                  //³õÊ¼»¯ GPIOB
	
    /* TIMÊ±¼ä»ùÊı³õÊ¼»¯½á¹¹Ìå */
	TIM_TimeBaseInitTypeDef  TIM_TimeBaseSrtructure;     
	TIM_TimeBaseSrtructure.TIM_Period= TIM4_Reload_Num_ARR;           //¼ÆÊıÆ÷TIMx_CNT¼ÆÊı£¬´Ó0ÀÛ¼Óµ½ARR´ÎºóÒç³ö£¬ÉèÖÃ×Ô¶¯ÖØ×°ÔØÖµ
	TIM_TimeBaseSrtructure.TIM_Prescaler=TIM4_Frequency_Divide_PSC;   //ÉèÖÃÔ¤·ÖÆµÏµÊı PSC
	TIM_TimeBaseSrtructure.TIM_ClockDivision=0;                       //1·ÖÆµ£¬ÓÃÓÚÂË²¨ĞÅºÅ¶¶¶¯
	TIM_TimeBaseSrtructure.TIM_CounterMode=TIM_CounterMode_Up;        //ÏòÉÏ¼ÆÊıÄ£Ê½Òç³ö
	TIM_TimeBaseInit(TIM4,&TIM_TimeBaseSrtructure);					  //³õÊ¼»¯TIM4µÄÊ±ÖÓ²ÎÊı
	
    /* TIMÊä³ö±È½Ï¹¦ÄÜ³õÊ¼»¯½á¹¹Ìå */
	TIM_OCInitTypeDef	TIM_OCInitStructure;             
	TIM_OCInitStructure.TIM_OCMode=TIM_OCMode_PWM1;     			  //Ñ¡Ôñ¶¨Ê±Æ÷Ä£Ê½Îª±È½ÏµÍÊä³ö¡£
	TIM_OCInitStructure.TIM_OutputState = TIM_OutputState_Enable;     //±È½ÏÊä³öÊ¹ÄÜ
	TIM_OCInitStructure.TIM_Pulse =(TIM4_Reload_Num_ARR+1)*0;         //±È½ÏÊä³öÂö³å¿í¶È£¬ÉèÖÃÕ¼¿Õ±È£¨³õÊ¼»¯ÓÃ£©,¼´CCR
	TIM_OCInitStructure.TIM_OCPolarity=TIM_OCPolarity_High;           //Êä³ö¼«ĞÔ£ºTIMÊä³ö±È½Ï¼«ĞÔ¸ß
	
	
	TIM_OC1Init(TIM4,&TIM_OCInitStructure);          				  //³õÊ¼»¯TIM4  CH1µÄÊ±ÖÓ£¬ÏÂÍ¬	
	TIM_OC2Init(TIM4,&TIM_OCInitStructure);
	TIM_OC3Init(TIM4,&TIM_OCInitStructure);
	TIM_OC4Init(TIM4,&TIM_OCInitStructure);
	
	/* ³õÊ¼»¯CH1/2/3/4 */
	TIM_OC1PreloadConfig(TIM4,TIM_OCPreload_Enable);                  //CH1 Ô¤×°ÔØÊ¹ÄÜ£¬¹¦ÄÜÔÚARRºÍCCR1¸Ä±äÊ±£¬µÈËûÃÇ¼ÆÊıÍêÒ»¸öÖÜÆÚÔÙĞŞ¸Ä
	TIM_OC2PreloadConfig(TIM4,TIM_OCPreload_Enable);                  //CH2 Ô¤×°ÔØÊ¹ÄÜ
	TIM_OC3PreloadConfig(TIM4,TIM_OCPreload_Enable);                  //CH3 Ô¤×°ÔØÊ¹ÄÜ
	TIM_OC4PreloadConfig(TIM4,TIM_OCPreload_Enable);                  //CH4 Ô¤×°ÔØÊ¹ÄÜ
	TIM_ARRPreloadConfig(TIM4,ENABLE);                                //Ê¹ÄÜ TIMxÔÚARRÉÏµÄÔ¤×°ÔØ¼Ä´æÆ÷
	
	TIM_Cmd(TIM4, ENABLE);                                            //Ê¹ÄÜ TIM4


}


//https://www.iotword.com/7734.html
void PWM_TIM1_Init(void) 
{
	GPIO_InitTypeDef		GPIOInitStruct;	

	RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOB, ENABLE);	/*??GPIOA,GPIOB??*/
	
	GPIOInitStruct.GPIO_Mode = GPIO_Mode_AF_PP;
	GPIOInitStruct.GPIO_Speed = GPIO_Speed_50MHz;
	
//	GPIOInitStruct.GPIO_Pin = GPIO_Pin_8;											/*PA8:CH1*/
//	GPIO_Init(GPIOA, &GPIOInitStruct);
	
	GPIOInitStruct.GPIO_Pin = GPIO_Pin_13;											/*PB13:CH1N*/
	GPIO_Init(GPIOB, &GPIOInitStruct);
	
//	GPIOInitStruct.GPIO_Mode = GPIO_Mode_IN_FLOATING;				
//	GPIOInitStruct.GPIO_Pin = GPIO_Pin_12;											/*PB12:BKIN*/
//	GPIO_Init(GPIOB, &GPIOInitStruct);

//	GPIO_SetBits(GPIOB, GPIO_Pin_12);
	
	
    TIM_TimeBaseInitTypeDef		TIMTimeBaseStruct;
	TIM_OCInitTypeDef			TIMOCInitStruct;
	TIM_BDTRInitTypeDef			TIMBDTRInitStruct;
 
	RCC_APB2PeriphClockCmd(RCC_APB2Periph_TIM1, ENABLE); 							/*??TIM1??*/
 
	/*???????*/
	TIMTimeBaseStruct.TIM_Period = 200 - 1;										/*?0?? ????????1000?*/ 
	/*?????:72MHz / 7200 = 10kHz;??:(1 / 10kHz) * 1000 = 100us*/
	TIMTimeBaseStruct.TIM_Prescaler = 7200 - 1;										/*?????10kHz,??????? 100us*/
	/*??????????:1000 * 100us = 100ms*/
	TIMTimeBaseStruct.TIM_ClockDivision = TIM_CKD_DIV1; 							/*?????? = 1,tDTS=tCKINT*/
	TIMTimeBaseStruct.TIM_CounterMode = TIM_CounterMode_Up; 						/*????*/
	TIMTimeBaseStruct.TIM_RepetitionCounter = 0; 									/*???????*/
	TIM_TimeBaseInit(TIM1, &TIMTimeBaseStruct); 
 
	/*?????????*/
	TIMOCInitStruct.TIM_OCMode = TIM_OCMode_PWM1;									/*PWM1??*/
	TIMOCInitStruct.TIM_OutputState = TIM_OutputState_Enable;						/*????*/
	TIMOCInitStruct.TIM_OutputNState = TIM_OutputNState_Enable;						/*??????*/
	TIMOCInitStruct.TIM_OCPolarity = TIM_OCPolarity_High;							/*??????????*/
	TIMOCInitStruct.TIM_OCNPolarity = TIM_OCNPolarity_High;							/*????????????*/
	TIMOCInitStruct.TIM_OCIdleState = TIM_OCIdleState_Set;							/*?????????*/
	TIMOCInitStruct.TIM_OCNIdleState = TIM_OCNIdleState_Reset;						/*???????????*/
 
	/*???TIM1???1*/
	TIMOCInitStruct.TIM_Pulse = 175 -1;//50 - 1; 75% 											/*??? = 250 / 1000 = 25%*/
	TIM_OC1Init(TIM1,&TIMOCInitStruct);
	TIM_OC1PreloadConfig(TIM1, TIM_OCPreload_Enable);								/*?????,??????????????*/		
 
	/*??????????*/
	TIMBDTRInitStruct.TIM_OSSRState = TIM_OSSRState_Enable;							/*?????“????”?? = 1*/
	TIMBDTRInitStruct.TIM_OSSIState = TIM_OSSIState_Enable;							/*?????“????”?? = 1*/
	TIMBDTRInitStruct.TIM_LOCKLevel = TIM_LOCKLevel_1;								/*????1,?????*/
	TIMBDTRInitStruct.TIM_DeadTime = 0x80;											/*????:12.8ms*/
	TIMBDTRInitStruct.TIM_Break = TIM_Break_Enable;									/*??????*/
	TIMBDTRInitStruct.TIM_BreakPolarity = TIM_BreakPolarity_Low;					/*?????????,??????????????PWM???,????????*/
	TIMBDTRInitStruct.TIM_AutomaticOutput = TIM_AutomaticOutput_Enable;				/*??????*/
	TIM_BDTRConfig(TIM1, &TIMBDTRInitStruct);
 
	TIM_Cmd(TIM1, ENABLE);  														/*?????,???????*/
	
	TIM_CtrlPWMOutputs(TIM1, ENABLE);
	
	//TIM_SetCompare1(TIM1, 189);
	TIM_SetCompare1(TIM1, 185);
}
//TIM_SetCompare£¨x£©()º¯Êı¿ÉÒÔ¸Ä±äÕ¼¿Õ±È

/***************************************************
TIM2Í¨µÀ1/2¿ØÖÆÇ°×óÂÖµç»úÕı·´×ª£¬CCR1>CCR2Ê±Õı×ª
TIM2Í¨µÀ3/4¿ØÖÆÇ°ÓÒÂÖµç»úÕı·´×ª£¬CCR3>CCR4Ê±Õı×ª
TIM4Í¨µÀ1/2¿ØÖÆºó×óÂÖµç»úÕı·´×ª£¬CCR1>CCR2Ê±Õı×ª
TIM4Í¨µÀ3/4¿ØÖÆºóÓÒÂÖµç»úÕı·´×ª£¬CCR3>CCR4Ê±Õı×ª
***************************************************/

void car_forward()
{
	TIM_Cmd(TIM2, ENABLE);
	GPIO_SetBits(GPIOA, GPIO_Pin_15);                     //PA15_MotorAB_EN
	TIM_SetCompare1(TIM2,1000);        //ÉèÖÃTIM2  CH1Õ¼¿Õ±ÈÊä³ö  PA0
	TIM_SetCompare2(TIM2,0);          //ÉèÖÃTIM2  CH2Õ¼¿Õ±ÈÊä³ö  PA1
	TIM_SetCompare3(TIM2,0);       //ÉèÖÃTIM2  CH1Õ¼¿Õ±ÈÊä³ö  PA2
	TIM_SetCompare4(TIM2,1000);          //ÉèÖÃTIM2  CH2Õ¼¿Õ±ÈÊä³ö  PA3

//	TIM_SetCompare1(TIM4,0);          //ÉèÖÃTIM4  CH1Õ¼¿Õ±ÈÊä³ö  PB6
//	TIM_SetCompare2(TIM4,1500);       //ÉèÖÃTIM4  CH2Õ¼¿Õ±ÈÊä³ö  PB7
//	TIM_SetCompare3(TIM4,0);          //ÉèÖÃTIM4  CH3Õ¼¿Õ±ÈÊä³ö  PB8
//	TIM_SetCompare4(TIM4,2000);       //ÉèÖÃTIM4  CH4Õ¼¿Õ±ÈÊä³ö  PB9

}

void car_backward()
{
	TIM_Cmd(TIM2, ENABLE);
	GPIO_SetBits(GPIOA, GPIO_Pin_15);  //PA15_MotorAB_EN
	TIM_SetCompare1(TIM2, 0);            //ÉèÖÃTIM2  CH1Õ¼¿Õ±ÈÊä³ö  PA0
	TIM_SetCompare2(TIM2,1000);          //ÉèÖÃTIM2  CH2Õ¼¿Õ±ÈÊä³ö  PA1
	TIM_SetCompare3(TIM2, 1000);            //ÉèÖÃTIM2  CH1Õ¼¿Õ±ÈÊä³ö  PA2
	TIM_SetCompare4(TIM2,0);          //ÉèÖÃTIM2  CH2Õ¼¿Õ±ÈÊä³ö  PA3
}

void car_stop()
{
	GPIO_ResetBits(GPIOA, GPIO_Pin_15);
	
	TIM_Cmd(TIM2, DISABLE);
}

void car_turn_left()
{
	TIM_Cmd(TIM1, ENABLE); 
	
	TIM_CtrlPWMOutputs(TIM1, ENABLE);
	
	//TIM_SetCompare1(TIM1, 189);
	TIM_SetCompare1(TIM1, 189);
}

void car_turn_right()
{
	TIM_Cmd(TIM1, ENABLE); 
	
	TIM_CtrlPWMOutputs(TIM1, ENABLE);
	
	//TIM_SetCompare1(TIM1, 189);
	TIM_SetCompare1(TIM1, 180);
}

void car_turn_reset()
{
	TIM_Cmd(TIM1, ENABLE); 
	
	TIM_CtrlPWMOutputs(TIM1, ENABLE);
	
	//TIM_SetCompare1(TIM1, 189);
	TIM_SetCompare1(TIM1, 185);
}
	
